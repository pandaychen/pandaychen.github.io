---
layout:     post
title:  Linux 内核之旅（一）：进程
subtitle:   
date:       2024-10-02
author:     pandaychen
header-img:
catalog: true
tags:
    - Linux
---

##  0x00    前言

####    linux 的开机过程
计算机通电后，首先执行 BIOS 的自检，用于检查外围关键设备是否正常。BIOS 根据设置的启动顺序，搜索用于启动系统的驱动器，并将其 MBR 加载到内存，然后执行 MBR（BIOS 并不关心 MBR 中是什么内容，它只负责读取并执行），此时控制权被交到了 MBR，boot loader 找到和加载 Linux 内核到内存中，并将控制权移交给内核。linux 启动之后，** 内核只是存在于内存中的程序，它和其他程序一样，都是被 cpu 调度执行的 **。那么，cpu 的使用权什么情况下，会被交给内核，然后内核进行进程管理的呢？

####    CPU 特权指令（分级）
涉及到操作系统管理计算机资源的指令（敏感指令），只能被操作系统能够执行。x86 CPU 提供了 `RING0`（最高权限模式，可以执行所有指令）~`RING3`（最低权限模式，仅能执行指令集中的一部分指令）的特权分级，让 CPU 在执行操作系统代码的时候运行在 `Ring0` 模式，在执行普通应用程序代码的时候运行在 `Ring3` 模式，这样就解决了特权指令的问题

![CPU-RING0]()

####    内核地址空间
除了指令增加特权分级以外，在内存的访问也得加上特权级。由于 x86 架构的 CPU 是基于分段 + 分页式相结合的内存管理方式，通过给不同的内存段限定了不同的访问模式，并把它记录到了段的描述符中，在访问内存的时候，CPU 就会拿当前段寄存器中标示的权限和要访问的目标内存所在段段访问权限进行对比，符合要求才能访问，否则会抛出异常

1.  操作系统（Kernel）在内存中设定一块区域，将 OS Kernel 代码放在这块区域中，并设置了访问权限，非 `Ring0` 权限禁止访问
2.  操作系统又将该内存区域映射到了每一个进程的虚拟地址空间中，这样所有进程都可以看到该进程地址空间被 OS 占用，无法访问及修改

从而衍生出下面的若干概念：
-   操作系统设定的这段内存区域，一般称为内核地址空间
-   位于内核地址空间中的代码叫做操作系统的内核代码
-   位于应用程序代码所活动的区域叫做用户地址空间
-   CPU 执行内核代码的模式称为内核态
-   CPU 执行用户程序时的模式称为用户态

CPU 执行代码的过程，就是不断游走于用户态和内核态的过程（切换）

####    用户态与内核态的切换方式
CPU 提供了专门的入口，用来从用户态进入内核态（CPU 使用权移交）

- 中断：当硬件设备有消息来了之后，会通过中断通知 CPU，比如（移动鼠标，敲下键盘，收到了一个数据包等），当中断发生时，CPU 会将当前执行的上下文保存到栈中，转入内核执行中断处理程序。通过中断进入内核（入口是记录在中断描述符表 IDT）
- 异常：当 CPU 执行过程中发现一些异常情况，比如执行除法指令的除数是 0，访问的内存地址无效，或者访问的内存地址属于特权页面等这些情况，CPU 都会触发异常；同中断处理类似，遇到异常时，CPU 也会将执行的上下文保存在栈中，转入内核执行中断处理程序
-   系统调用：在系统编程中调用操作系统提供的 API 函数，比如文件操作、内存操作、网络操作等等，这些函数都是操作系统封装出来的应用程序编程 API，真正的底层实现是位于内核中的系统调用。应用层上的 API 通过 CPU 专门的指令进入内核来完成对应的功能

####    CPU 中断

####    内核态的意义

##  0x01    进程的基础概念



##  0x0 总结

####     内核态的意义
CPU 为了进行指令权限管控，引入了特权级的概念，CPU 工作在不同的特权级下能够执行的指令和可访问的内存区域是不一样的。计算机上电启动之处，CPU 运行在高特权级下，操作系统（Linux 内核）率先获得了执行权限，在内存设置一块固定区域并将自己的程序代码（内核代码）放了进去，并设定了这一部分内存只有高特权级才能访问。随后，操作系统在创建进程的时候，都会把自己所在的这块内存区域映射到每一个进程地址空间中，这样所有进程都能看到自己的进程空间中被映射的内核的区域，这一块区域是无法直接访问的。通常进入内核态是指：当中断、异常、系统调用等情况发生的时候，CPU 切换工作模式到高特权级模式 `Ring0`，并转而执行位于内核地址空间处的代码

##  0x02  参考
-   [Linux 进程是如何创建出来的？](https://cloud.tencent.com/developer/article/2187989)
-   [Linux 内核进程管理](http://timd.cn/kernel-process-management/)
-   <<深入理解 Linux 进程与内存>>
-   [CPU 进入内核，是什么意思？](https://mp.weixin.qq.com/s?__biz=MzkxNjE3NTAyNQ==&mid=2247485492&idx=1&sn=d3196f90d31ff19060e0105eba66723a&chksm=c152a9eaf62520fc87d306e42766ede75fc0457718adcc98acb1e15cf3497d1ef2e71619be5e#rd)